version: 2.1

description: |
  This orb creates a wrapper for the Aqua Security MicroScanner. This tool is freely available on GitHub.
examples:
  simple_build_and_scan:
    description: Scan a newly built docker image with the Aqua Security microscanner.
    usage:
      version: 2.1

      orbs:
        microscanner: aquasecurity/microscanner@dev:0.0.5

      jobs:
        docker-build:
          executor: microscanner/default
          steps:
            - checkout
            - run: docker build -t myrepo/myimage:tag .

      workflows:
        scan-image:
          jobs:
            - docker-build
            - microscanner/scan-image:
                requires: 
                  - docker-build
                context: myContext
                image: myrepo/myimage:mytag

executors:
  default:
    description: A debian-based machine executor.  Note that there is an 
                 overhead for provisioning a machine executor as a result of
                 spinning up a private Docker server. Use of the machine key
                 may require additional fees.
    machine: 
      image: circleci/classic:201808-01

commands:
  install:
    description: Obtain the Aqua MicroScanner binary
    parameters:
      token:
        description: The Aqua MicroScanner token
        type: string
        default: $AQUA_TOKEN
    steps:
      - run:
          name: Download scanning wrapper
          command: |
            git clone git@github.com:lukebond/microscanner-wrapper.git

  scan:
    description: Scan container image
    parameters:
      token:
        description: The Aqua MicroScanner token
        type: string
        default: $AQUA_TOKEN
      microscanner_options:
        description: This var allows for option flags to be passed to the MicroScanner.
        type: string
        default: $MICROSCANNER_OPTIONS
      image:
        description: The image to scan
        type: string
      artifact-type:
        description: The type of artifact to output, options are json and html
        type: string
        default: html
    steps:
      - run:
          name: Scan for vulneribilities and upload report
          command: |
            mkdir scanresult
            cd microscanner-wrapper
            if [[ <<parameters.artifact-type>> == json ]]; then
              MICROSCANNER_OPTIONS=<<parameters.microscanner_options>>
              MICROSCANNER_OPTIONS="${MICROSCANNER_OPTIONS:-'--json'}"
              MICROSCANNER_TOKEN=<<parameters.token>>
              ./scan.sh <<parameters.image>> > ../scanresult/AquaMicroscannerOutput.json
            else
              MICROSCANNER_OPTIONS=<<parameters.microscanner_options>> 
              MICROSCANNER_OPTIONS="${MICROSCANNER_OPTIONS:-'--html'}"
              MICROSCANNER_TOKEN=<<parameters.token>> 
              ./scan.sh <<parameters.image>> > ../scanresult/AquaMicroscannerOutput.html
            fi
      - store_artifacts:
          path: scanresult

jobs:
  scan-image:
    executor: default
    parameters:
      token:
        description: The Aqua microscanner token
        type: string
        default: $AQUA_TOKEN
      microscanner_options:
        description: This var allows for option flags to be passed to the MicroScanner.
        type: string
        default: $MICROSCANNER_OPTIONS
      image:
        description: The image to scan
        type: string
      artifact-type:
        description: The type of artifact to output
        type: string
        default: html
      dockerfile-path:
        description: The path to your Dockerfile
        type: string
        default: .
    steps:
      - install 
      - scan:
          image: <<parameters.image>>
